<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ù…Ø§ÛŒØ´ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ NATI</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<style>
body { background:#f6f6fb; overflow:hidden; height:100vh; display:flex; direction:rtl; }
#sidebar { width:260px; min-width:60px; max-width:400px; background:#fff; border-left:1px solid #ddd; overflow-y:auto; padding:12px; box-shadow:-2px 0 6px rgba(0,0,0,0.05); transition: width 0.3s ease; }
#sidebar.collapsed { width:0; padding:0; overflow:hidden; }
#toggleSidebar { position:fixed; top:10px; right:10px; z-index:1100; background:#007bff; color:#fff; border:none; padding:6px 10px; cursor:pointer; border-radius:4px; }
#main { flex:1; padding:16px; overflow-y:auto; transition: margin-right 0.3s ease; margin-right:260px; }
#sidebar.collapsed + #main { margin-right:0; }
.sheet-item { padding:10px; margin:6px 0; border-radius:6px; cursor:pointer; border:1px solid #e0e0ef; background:#fafafa; font-size:15px; }
.sheet-item:hover { background:#eef; }
.sheet-item.active { background:#dde5ff; border-color:#b9c6ff; }
.toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:1055; }
.recording-indicator { width:10px; height:10px; background:red; border-radius:50%; margin-left:6px; animation:blink 1s infinite; display:none; }
@keyframes blink {0%,50%,100%{opacity:1;}25%,75%{opacity:0;}}
.btn-fixed { height:32px; font-size:13px; line-height:1; padding:0 4px; overflow:hidden; display:block; width:100%; }
td.row-number { width:5%; text-align:center; vertical-align:middle; }
td.controls-cell { width:10%; }
td.dialog-cell { width:85%; text-align:center; }
</style>
</head>
<body>

<div id="sidebar">
<h3>Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
<div id="sheetList">â€” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ â€”</div>
<hr>
<div id="audioInputContainer" class="mb-2" style="display:none">
<label>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ (ÛŒÚ©Ø¬Ø§):</label>
<input id="audioFiles" type="file" accept="audio/*" multiple class="form-control form-control-sm">
</div>
<label>ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„:</label>
<input id="excelFile" type="file" accept=".xlsx,.xls" class="form-control form-control-sm">
</div>

<button id="toggleSidebar" onclick="toggleSidebar()">â˜°</button>

<div id="main">
<h2 id="sheetTitle">Ú¯ÙØªÚ¯Ùˆ</h2>
<div id="tableContainer">â€” Ù‡ÛŒÚ† Ø´ÛŒØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ â€”</div>
</div>

<div id="toast" class="toast align-items-center text-white bg-dark border-0" role="alert"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let workbook=null,audioFilesSorted=[],currentAudio=null,currentBtn=null,mediaRecorder=null,recordedChunks=[],mediaStream=null;
const sheetList=document.getElementById('sheetList');
const excelInput=document.getElementById('excelFile');
const audioInput=document.getElementById('audioFiles');
const audioInputContainer=document.getElementById('audioInputContainer');
const tableContainer=document.getElementById('tableContainer');
const sheetTitle=document.getElementById('sheetTitle');
const toastEl=document.getElementById('toast');
const sidebar=document.getElementById('sidebar');
const toggleBtn=document.getElementById('toggleSidebar');
const main=document.getElementById('main');
const bsToast=new bootstrap.Toast(toastEl);

function showToast(msg){ toastEl.textContent=msg; bsToast.show(); }

async function loadDefaultExcel() {
  try {
    const response = await fetch('Conversations.xlsx');
    const arrayBuffer = await response.arrayBuffer();
    workbook = XLSX.read(arrayBuffer, { type: 'array' });
    renderSheetList();
    if(workbook.SheetNames.length > 0){
      const firstSheet = document.createElement('div');
      firstSheet.className='sheet-item';
      firstSheet.textContent = workbook.SheetNames[0];
      sheetList.prepend(firstSheet);
      selectSheet(workbook.SheetNames[0], firstSheet);
    }
  } catch(err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶:', err);
    sheetList.textContent = 'â€” ÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ â€”';
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
excelInput.addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const data=await f.arrayBuffer();
  workbook=XLSX.read(data,{type:'array'});
  renderSheetList();
});

audioInput.addEventListener('change', e=>{
  audioFilesSorted=[...e.target.files].sort((a,b)=>a.name.localeCompare(b.name));
});

function renderSheetList(){
  sheetList.innerHTML='';
  workbook.SheetNames.forEach(name=>{
    const div=document.createElement('div');
    div.className='sheet-item'; div.textContent=name;
    div.onclick=()=>selectSheet(name,div);
    sheetList.appendChild(div);
  });
}

function selectSheet(name,element){
  [...document.querySelectorAll('.sheet-item')].forEach(el=>el.classList.remove('active'));
  element.classList.add('active');
  sheetTitle.textContent=`Ú¯ÙØªÚ¯Ùˆ: ${name}`;
  showToast(`Ø¯ÛŒØ§Ù„ÙˆÚ¯: ${name}`);
  loadSheet(name);
  audioInputContainer.style.display='block';
}

function loadSheet(name){
  const ws=workbook.Sheets[name];
  const json=XLSX.utils.sheet_to_json(ws,{header:1});
  let html=`<table class="table table-striped table-bordered align-middle" style="table-layout: fixed;">
  <colgroup>
    <col style="width:5%">
    <col style="width:10%">
    <col style="width:85%">
  </colgroup>
  <thead class="table-dark"><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§</th><th>Ù…ØªÙ†</th></tr></thead>
  <tbody>`;
  
  for(let i=1;i<json.slice(1).length;i+=2){
    const idx=Math.floor((i-1)/2);
    html+='<tr>';
    html+=`<td class="row-number">${idx+1}</td>`;
    let combinedText='';
    for(let j=i;j<i+2 && j<json.slice(1).length;j++){
      if(json[j].length>0) combinedText+=`<span>${json[j].join(' ')}</span>`;
    }
    html+=`<td class="controls-cell">
<span class="recording-indicator" id="rec_${idx}"></span>
<button class="btn btn-primary btn-fixed mb-1" onclick="toggleAudio(${idx},this)">â–¶ Ù¾Ø®Ø´</button>
<button class="btn btn-secondary btn-fixed mb-1" onclick="toggleText(${idx})">Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ</button>
<button class="btn btn-success btn-fixed mb-1" onclick="recordAudio(${idx})">ğŸ¤ Ø¶Ø¨Ø·</button>
<audio id="myAudio_${idx}" controls class="w-100 mt-1" style="display:none"></audio>
</td>`;
    html+=`<td class="dialog-cell" id="dialog_${idx}" style="display:none">${combinedText}</td>`;
    html+='</tr>';
  }
  html+='</tbody></table>';
  tableContainer.innerHTML=html;
}

function toggleAudio(index,btn){
  if(currentAudio && !currentAudio.paused){ 
    currentAudio.pause(); 
    if(currentBtn) currentBtn.textContent='â–¶ Ù¾Ø®Ø´'; 
    if(currentAudio.datasetIndex==index){ currentAudio=null;currentBtn=null; return; } 
  }
  if(!audioFilesSorted[index]){ alert('ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ùˆ Ø±Ø¯ÛŒÙ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return; }
  currentAudio=new Audio(URL.createObjectURL(audioFilesSorted[index]));
  currentAudio.datasetIndex=index; currentBtn=btn; btn.textContent='â¹ ØªÙˆÙ‚Ù'; currentAudio.play();
  currentAudio.onended=()=>{ btn.textContent='â–¶ Ù¾Ø®Ø´'; currentAudio=null;currentBtn=null; };
}

function toggleText(index){
  const el=document.getElementById(`dialog_${index}`);
  el.style.display=(el.style.display==='none'||el.style.display==='')?'block':'none';
}

async function initMedia(){
  if(!mediaStream){
    try{ mediaStream=await navigator.mediaDevices.getUserMedia({audio:true}); showToast('Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª'); }
    catch(err){ alert('Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡'); }
  }
  return mediaStream;
}

function recordAudio(index){
  const audioEl=document.getElementById(`myAudio_${index}`);
  const indicator=document.getElementById(`rec_${index}`);
  initMedia().then(stream=>{
    if(!stream) return;
    if(!mediaRecorder || mediaRecorder.state==='inactive'){
      mediaRecorder=new MediaRecorder(stream); recordedChunks=[];
      mediaRecorder.ondataavailable=e=>recordedChunks.push(e.data);
      mediaRecorder.onstop=()=>{
        const blob=new Blob(recordedChunks,{type:'audio/webm'});
        audioEl.src=URL.createObjectURL(blob);
        audioEl.style.display='block'; recordedChunks=[];
        indicator.style.display='none';
      };
      mediaRecorder.start();
      indicator.style.display='inline-block';
      showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...');
    } else if(mediaRecorder.state==='recording'){ mediaRecorder.stop(); mediaRecorder=null; }
  });
}

function toggleSidebar(){
  sidebar.classList.toggle('collapsed');
}

window.onload = loadDefaultExcel;
</script>

</body>
</html>
